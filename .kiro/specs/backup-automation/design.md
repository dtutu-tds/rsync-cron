# Design Document

## Overview

Система автоматизации резервного копирования состоит из двух основных компонентов: команды rsync для ручного выполнения и автоматизированного скрипта с настройкой cron для регулярного выполнения. Решение использует стандартные инструменты Linux без дополнительных зависимостей.

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Home Dir      │───▶│   rsync Command  │───▶│  /tmp/backup    │
│   (~/)          │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌──────────────────┐
                       │   Backup Script  │
                       │                  │
                       └──────────────────┘
                              │
                              ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │   Cron Job       │───▶│  System Log     │
                       │   (daily)        │    │  (/var/log/)    │
                       └──────────────────┘    └─────────────────┘
```

## Components and Interfaces

### 1. Manual rsync Command
- **Purpose**: Выполнение задания 1 - создание команды для ручного копирования
- **Input**: Домашняя директория пользователя
- **Output**: Зеркальная копия в `/tmp/backup`
- **Parameters**:
  - `--archive`: Архивный режим (сохранение атрибутов)
  - `--delete`: Удаление файлов в назначении, отсутствующих в источнике
  - `--exclude='.*'`: Исключение скрытых файлов и директорий
  - `--checksum`: Принудительная проверка хэш-сумм
  - `--verbose`: Подробный вывод для скриншота

### 2. Backup Script
- **Purpose**: Автоматизированное выполнение резервного копирования
- **Location**: `/usr/local/bin/backup_home.sh`
- **Functionality**:
  - Выполнение rsync с теми же параметрами
  - Логирование результатов в syslog
  - Обработка ошибок
  - Создание директории назначения при необходимости

### 3. Cron Configuration
- **Purpose**: Планирование ежедневного выполнения
- **Schedule**: Ежедневно (предлагается 02:00)
- **User**: Текущий пользователь
- **Command**: Вызов backup script

## Data Models

### Backup Operation
```bash
# Структура команды rsync
rsync [OPTIONS] SOURCE DESTINATION

# Где:
# OPTIONS: --archive --delete --exclude='.*' --checksum --verbose
# SOURCE: $HOME/
# DESTINATION: /tmp/backup/
```

### Log Entry Format
```
[TIMESTAMP] backup_home: [SUCCESS|ERROR] - [MESSAGE]
```

## Error Handling

### rsync Command Errors
- **Exit Code 0**: Успешное выполнение
- **Exit Code 1**: Синтаксические ошибки
- **Exit Code 2**: Ошибки протокола
- **Exit Code 23**: Частичная передача (некоторые файлы не переданы)

### Script Error Handling
- Проверка существования исходной директории
- Создание целевой директории при необходимости
- Логирование всех операций
- Возврат соответствующих exit codes

### Cron Error Handling
- Перенаправление stdout и stderr в лог
- Использование абсолютных путей
- Проверка прав доступа

## Testing Strategy

### Manual Testing
1. **Задание 1**: Выполнение команды rsync вручную
   - Проверка создания копии
   - Проверка исключения скрытых файлов
   - Создание скриншота результата

2. **Задание 2**: Тестирование автоматизации
   - Проверка работы скрипта
   - Проверка записи в crontab
   - Проверка логирования
   - Создание скриншота crontab

### Validation Checks
- Сравнение размеров директорий (исключая скрытые файлы)
- Проверка отсутствия скрытых файлов в backup
- Проверка записей в системном логе
- Проверка выполнения cron задачи

## Implementation Notes

- Использование `$HOME` вместо `~` в скриптах для совместимости с cron
- Создание backup директории с правильными правами доступа
- Использование logger для записи в syslog
- Тестирование на реальных данных для получения достоверных скриншотов